<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Markdown Editor with Cytoscape Corkboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>
  <style>
    :root {
      --bg: #fafafa;
      --fg: #333;
      --maxw: 650px;
      --border: #ddd;
      --accent: #4b8bf4;
      --note-bg: #fff8dc;
    }
    
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--bg);
      color: var(--fg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    
    #container {
      flex: 1;
      display: flex;
      position: relative;
      max-height: calc(100vh - 60px);
      overflow: hidden;
    }
    
    .pane {
      height: 100%;
      overflow: auto;
      flex: 1;
      box-sizing: border-box;
      border-right: 1px solid var(--border);
      transition: flex 0.3s;
      max-height: 100%;
    }
    
    #edpane textarea {
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
      resize: none;
      max-width: var(--maxw);
      margin: auto;
      padding: 1em;
      line-height: 1.6;
      font-size: 1em;
      background: none;
      color: inherit;
      font-family: inherit;
      box-sizing: border-box;
      transition: opacity 0.3s;
    }
    
    #prepane textarea {
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
      resize: none;
      max-width: var(--maxw);
      margin: auto;
      padding: 1em;
      line-height: 1.6;
      font-size: 1em;
      background: none;
      color: inherit;
      font-family: inherit;
      box-sizing: border-box;
      transition: opacity 0.3s;
    }
    
    #preview {
      max-width: var(--maxw);
      margin: auto;
      line-height: 1.6;
    }
    
    #corkpane {
      height: 100%;
      overflow: hidden;
      flex: 1;
      box-sizing: border-box;
      border-right: 1px solid var(--border);
      transition: flex 0.3s;
      position: relative;
    }
    
    #cork-board {
      width: 100%;
      height: 100%;
    }
    
    #toolbar {
      background: var(--bg);
      padding: 10px;
      display: flex;
      gap: 10px;
      border-top: 1px solid var(--border);
      justify-content: space-between;
    }
    
    .toolbar-section {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    button {
      padding: 5px 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--fg);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    button:hover {
      background: #f0f0f0;
    }
    
    button.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .stats {
      font-size: 0.8em;
      color: #888;
    }
    
    #quick-format {
      display: flex;
      gap: 5px;
    }
    
    .format-btn {
      padding: 3px 8px;
      font-size: 0.9em;
    }
    
    #cork-controls {
      position: absolute;
      bottom: 10px;
      right: 10px;
      z-index: 10;
      display: flex;
      gap: 5px;
      background: var(--bg);
      padding: 5px;
      border-radius: 4px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .cork-btn {
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 16px;
    }
    
    .cork-btn:hover {
      background: #f0f0f0;
    }
    
    .note-editor {
      position: absolute;
      z-index: 100;
      background: var(--note-bg);
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      width: 300px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      display: none;
    }
    
    .note-editor input, 
    .note-editor textarea {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 3px;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 14px;
    }
    
    .note-editor textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .note-editor-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 5px;
    }
    
    .context-menu {
      position: absolute;
      z-index: 200;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .menu-item {
      padding: 5px 10px;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .menu-item:hover {
      background: var(--accent);
      color: white;
    }
    
    #search-container {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 100;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: none;
    }
    
    #search-input {
      border: 1px solid var(--border);
      padding: 5px;
      border-radius: 4px;
      font-size: 14px;
    }
    
    body.dark {
      --bg: #222;
      --fg: #eee;
      --border: #444;
      --accent: #5d93f5;
      --note-bg: #3a3a20;
    }
    
    body.dark button:hover {
      background: #333;
    }
    
    body.dark .cork-btn:hover {
      background: #333;
    }
    
    #floating-buttons {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
    }
    
    .floating-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 20px;
      border: none;
    }
    
    .note-sidebar {
      position: absolute;
      top: 0;
      right: 0;
      width: 300px;
      height: 100%;
      background: var(--bg);
      border-left: 1px solid var(--border);
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      display: none;
      z-index: 50;
      box-sizing: border-box;
      transition: transform 0.3s;
      overflow: auto;
    }
    
    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .sidebar-header h3 {
      margin: 0;
      font-size: 18px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }
    
    .sidebar-header button {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--fg);
    }
    
    .sidebar-content {
      padding: 15px;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    
    .sidebar-actions {
      padding: 15px;
      display: flex;
      gap: 10px;
      border-top: 1px solid var(--border);
    }
    
    .note-tooltip {
      position: absolute;
      background: var(--bg);
      border: 1px solid var(--border);
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 100;
      max-width: 250px;
      display: none;
      font-size: 12px;
      pointer-events: none;
    }
    
    .note-tooltip-title {
      font-weight: bold;
      margin-bottom: 5px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 3px;
    }
    
    .note-tooltip-content {
      white-space: pre-wrap;
      max-height: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="edpane" class="pane">
      <textarea id="editor" placeholder="Start writing‚Ä¶"></textarea>
    </div>
    <div id="prepane" class="pane">
      <div id="preview"></div>
    </div>
    <div id="corkpane" class="pane">
      <div id="cork-board"></div>
      <div id="cork-controls">
        <button class="cork-btn" id="add-note-btn" title="Add note">+</button>
        <button class="cork-btn" id="fit-btn" title="Fit to view">‚Üî</button>
        <button class="cork-btn" id="layout-btn" title="Auto layout">‚ãÆ</button>
        <button class="cork-btn" id="options-btn" title="Options">‚ãÆ</button>
      </div>
      <div class="note-editor" id="note-editor">
        <input type="text" id="note-title" placeholder="Note title">
        <textarea id="note-content" placeholder="Note content"></textarea>
        <div class="note-editor-buttons">
          <button id="save-note-btn">Save</button>
          <button id="cancel-note-btn">Cancel</button>
        </div>
      </div>
      <div id="note-sidebar" class="note-sidebar">
        <div class="sidebar-header">
          <h3 id="sidebar-title">Note Title</h3>
          <button id="close-sidebar">√ó</button>
        </div>
        <div id="sidebar-content" class="sidebar-content"></div>
        <div class="sidebar-actions">
          <button id="sidebar-edit-btn">Edit</button>
          <button id="sidebar-connect-btn">Connect</button>
          <button id="sidebar-insert-btn">Insert in Editor</button>
        </div>
      </div>
      <div id="note-tooltip" class="note-tooltip"></div>
    </div>
    
    <div id="search-container">
      <input type="text" id="search-input" placeholder="Search...">
    </div>
  </div>
  
  <div id="toolbar">
    <div class="toolbar-section">
      <button id="editor-btn" class="toggle active">Editor</button>
      <button id="preview-btn" class="toggle">Preview</button>
      <button id="corkboard-btn" class="toggle">Corkboard</button>
    </div>
    
    <div class="toolbar-section" id="quick-format">
      <button class="format-btn" data-format="bold">B</button>
      <button class="format-btn" data-format="italic">I</button>
      <button class="format-btn" data-format="heading">H</button>
      <button class="format-btn" data-format="link">üîó</button>
      <button class="format-btn" data-format="list">‚Ä¢</button>
      <button class="format-btn" data-format="code">{ }</button>
    </div>
    
    <div class="toolbar-section">
      <span class="stats" id="word-count">0 words</span>
      <button id="search-btn">üîç</button>
      <button id="theme-btn">Theme</button>
    </div>
  </div>
  
  <div id="floating-buttons">
    <button class="floating-btn" id="capture-btn" title="Capture selection">+</button>
  </div>

  <script>
    (function() {
      // DOM Elements
      const editorPane = document.getElementById('edpane');
      const previewPane = document.getElementById('prepane');
      const corkPane = document.getElementById('corkpane');
      const editor = document.getElementById('editor');
      const preview = document.getElementById('preview');
      const corkBoard = document.getElementById('cork-board');
      const wordCount = document.getElementById('word-count');
      const searchContainer = document.getElementById('search-container');
      const searchInput = document.getElementById('search-input');
      
      // Toolbar buttons
      const editorBtn = document.getElementById('editor-btn');
      const previewBtn = document.getElementById('preview-btn');
      const corkboardBtn = document.getElementById('corkboard-btn');
      const searchBtn = document.getElementById('search-btn');
      const themeBtn = document.getElementById('theme-btn');
      const formatBtns = document.querySelectorAll('.format-btn');
      
      // Corkboard controls
      const addNoteBtn = document.getElementById('add-note-btn');
      const fitBtn = document.getElementById('fit-btn');
      const layoutBtn = document.getElementById('layout-btn');
      const optionsBtn = document.getElementById('options-btn');
      const noteEditor = document.getElementById('note-editor');
      const noteTitle = document.getElementById('note-title');
      const noteContent = document.getElementById('note-content');
      const saveNoteBtn = document.getElementById('save-note-btn');
      const cancelNoteBtn = document.getElementById('cancel-note-btn');
      
      // Floating buttons
      const captureBtn = document.getElementById('capture-btn');
      
      // Application state
      let visiblePanes = {
        editor: true,
        preview: false,
        corkboard: false
      };
      let searchMode = false;
      let editingNode = null;
      let cy; // Cytoscape instance
      
      // Initialize Cytoscape
      function initCytoscape() {
        cy = cytoscape({
          container: document.getElementById('cork-board'),
          
          style: [
            {
              selector: 'node',
              style: {
                'label': 'data(title)',
                'text-valign': 'center',
                'text-halign': 'center',
                'background-color': getComputedStyle(document.documentElement).getPropertyValue('--note-bg').trim(),
                'color': getComputedStyle(document.documentElement).getPropertyValue('--fg').trim(),
                'border-color': '#ccc',
                'border-width': 1,
                'shape': 'rectangle',
                'width': 150,
                'height': 80,
                'text-max-width': '140px',
                'text-wrap': 'wrap',
                'font-size': '14px'
              }
            },
            {
              selector: 'node:selected',
              style: {
                'border-color': getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),
                'border-width': 2,
                'background-color': function(ele) {
                  const bg = getComputedStyle(document.documentElement).getPropertyValue('--note-bg').trim();
                  return document.body.classList.contains('dark') ? 
                    lightenColor(bg, 10) : darkenColor(bg, 10);
                }
              }
            },
            {
              selector: 'edge',
              style: {
                'width': 2,
                'line-color': getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),
                'target-arrow-color': getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),
                'curve-style': 'bezier',
                'target-arrow-shape': 'triangle',
                'arrow-scale': 0.8
              }
            }
          ],
          
          // Interaction options
          minZoom: 0.2,
          maxZoom: 4,
          wheelSensitivity: 0.2
        });
        
        // Double-click to edit node
        cy.on('dbltap', 'node', function(e) {
          editNode(e.target);
        });
        
        // Select node to show sidebar
        cy.on('select', 'node', function(e) {
          showNodeSidebar(e.target);
        });
        
        // Deselect to hide sidebar if clicking on background
        cy.on('unselect', 'node', function(e) {
          // Only hide sidebar if no other nodes are selected
          if (cy.nodes(':selected').length === 0) {
            hideNodeSidebar();
          }
        });
        
        // Right-click on node for context menu
        cy.on('cxttap', 'node', function(e) {
          showNodeContextMenu(e.target, e.renderedPosition);
        });
        
        // Right-click on edge to delete
        cy.on('cxttap', 'edge', function(e) {
          cy.remove(e.target);
          saveData();
        });
        
        // Handle node selection for connecting
        let connectingSource = null;
        
        cy.on('tap', function(e) {
          if (connectingSource && e.target !== connectingSource && e.target.isNode && e.target.isNode()) {
            // Create connection
            cy.add({
              group: 'edges',
              data: {
                source: connectingSource.id(),
                target: e.target.id()
              }
            });
            
            connectingSource = null;
            document.body.style.cursor = 'default';
            saveData();
          } else if (connectingSource && e.target === cy) {
            // Cancel connection when clicking on background
            connectingSource = null;
            document.body.style.cursor = 'default';
          }
        });
        
        // Mouse over node for tooltip
        cy.on('mouseover', 'node', function(e) {
          showNodeTooltip(e.target, e.renderedPosition);
        });
        
        cy.on('mouseout', 'node', function() {
          hideNodeTooltip();
        });
        
        // Update theme styles
        const updateThemeStyles = () => {
          const noteColor = getComputedStyle(document.documentElement).getPropertyValue('--note-bg').trim();
          const textColor = getComputedStyle(document.documentElement).getPropertyValue('--fg').trim();
          const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
          
          cy.style()
            .selector('node')
            .style({
              'background-color': noteColor,
              'color': textColor,
            })
            .selector('edge')
            .style({
              'line-color': accentColor,
              'target-arrow-color': accentColor
            })
            .update();
        };
        
        // Detect theme changes
        const observer = new MutationObserver(mutations => {
          mutations.forEach(mutation => {
            if (mutation.attributeName === 'class') {
              updateThemeStyles();
            }
          });
        });
        
        observer.observe(document.body, { attributes: true });
        
        // Helper function to start connecting nodes
        window.connectNode = function(nodeId) {
          const node = cy.getElementById(nodeId);
          if (node.length > 0) {
            connectingSource = node;
            document.body.style.cursor = 'crosshair';
          }
        };
      }
      
      // Edit a node
      function editNode(node) {
        editingNode = node;
        
        // Position editor near the node
        const pos = node.renderedPosition();
        noteEditor.style.left = (pos.x - 150) + 'px';
        noteEditor.style.top = (pos.y - 100) + 'px';
        noteEditor.style.display = 'block';
        
        // Set values
        noteTitle.value = node.data('title') || '';
        noteContent.value = node.data('content') || '';
        
        // Focus title
        noteTitle.focus();
      }
      
      // Show context menu for node
      function showNodeContextMenu(node, position) {
        // Create menu
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        menu.style.left = position.x + 'px';
        menu.style.top = position.y + 'px';
        
        // Menu items
        const items = [
          { label: 'Edit', action: () => editNode(node) },
          { label: 'Connect', action: () => {
            connectNode(node.id());
            menu.remove();
          }},
          { label: 'Copy Content', action: () => {
            navigator.clipboard.writeText(node.data('content') || '');
            menu.remove();
          }},
          { label: 'Insert in Editor', action: () => {
            const content = node.data('content') || '';
            const cursorPos = editor.selectionStart;
            editor.value = editor.value.substring(0, cursorPos) + 
                          content + 
                          editor.value.substring(cursorPos);
            editor.focus();
            updateWordCount();
            updatePreview();
            saveData();
            menu.remove();
            
            // Show editor pane if not visible
            if (!visiblePanes.editor) {
              visiblePanes.editor = true;
              updateLayout();
            }
          }},
          { label: 'Delete', action: () => {
            cy.remove(node);
            saveData();
            menu.remove();
          }}
        ];
        
        // Create menu items
        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'menu-item';
          div.textContent = item.label;
          div.addEventListener('click', item.action);
          menu.appendChild(div);
        });
        
        // Add to DOM
        document.body.appendChild(menu);
        
        // Close when clicking outside
        const closeMenu = (e) => {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('mousedown', closeMenu);
          }
        };
        
        setTimeout(() => {
          document.addEventListener('mousedown', closeMenu);
        }, 10);
      }
      
      // Show node tooltip
      function showNodeTooltip(node, position) {
        const tooltip = document.getElementById('note-tooltip');
        const title = node.data('title') || 'Untitled';
        const content = node.data('content') || '';
        
        // Create tooltip content
        tooltip.innerHTML = `
          <div class="note-tooltip-title">${title}</div>
          <div class="note-tooltip-content">${content}</div>
        `;
        
        // Position tooltip
        tooltip.style.left = (position.x + 10) + 'px';
        tooltip.style.top = (position.y + 10) + 'px';
        tooltip.style.display = 'block';
      }
      
      // Hide node tooltip
      function hideNodeTooltip() {
        const tooltip = document.getElementById('note-tooltip');
        tooltip.style.display = 'none';
      }
      
      // Show node sidebar
      function showNodeSidebar(node) {
        const sidebar = document.getElementById('note-sidebar');
        const title = document.getElementById('sidebar-title');
        const content = document.getElementById('sidebar-content');
        const editBtn = document.getElementById('sidebar-edit-btn');
        const connectBtn = document.getElementById('sidebar-connect-btn');
        const insertBtn = document.getElementById('sidebar-insert-btn');
        
        // Set content
        title.textContent = node.data('title') || 'Untitled';
        content.textContent = node.data('content') || '';
        
        // Update buttons
        editBtn.onclick = () => editNode(node);
        connectBtn.onclick = () => {
          connectNode(node.id());
          hideNodeSidebar();
        };
        insertBtn.onclick = () => {
          const noteContent = node.data('content') || '';
          const cursorPos = editor.selectionStart;
          editor.value = editor.value.substring(0, cursorPos) + 
                        noteContent + 
                        editor.value.substring(cursorPos);
          editor.focus();
          updateWordCount();
          updatePreview();
          saveData();
          
          // Show editor pane if not visible
          if (!visiblePanes.editor) {
            visiblePanes.editor = true;
            updateLayout();
          }
        };
        
        // Show sidebar
        sidebar.style.display = 'block';
      }
      
      // Hide node sidebar
      function hideNodeSidebar() {
        const sidebar = document.getElementById('note-sidebar');
        sidebar.style.display = 'none';
      }
      
      // Create a new note
      function createNote(content = '') {
        // Get center of viewport
        const center = cy.getCenterCoordinates ? 
          cy.getCenterCoordinates() : 
          { x: corkBoard.clientWidth / 2, y: corkBoard.clientHeight / 2 };
        
        // Create with random position near center
        const x = center.x + (Math.random() * 100 - 50);
        const y = center.y + (Math.random() * 100 - 50);
        
        // Create node
        const node = cy.add({
          group: 'nodes',
          data: {
            id: 'note-' + Date.now(),
            title: 'New Note',
            content: content || 'Double-click to edit'
          },
          position: { x, y }
        });
        
        // Select and edit
        node.select();
        editNode(node);
        
        saveData();
        return node;
      }
      
      // Markdown parsing (basic)
      function escapeHtml(s) {
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      }
      
      function parseMarkdown(md) {
        let html = escapeHtml(md);
        html = html
          .replace(/```([\s\S]*?)```/g,(_,c)=>'<pre><code>'+escapeHtml(c)+'</code></pre>')
          .replace(/^###### (.*)$/gm,'<h6>$1</h6>')
          .replace(/^##### (.*)$/gm,'<h5>$1</h5>')
          .replace(/^#### (.*)$/gm,'<h4>$1</h4>')
          .replace(/^### (.*)$/gm,'<h3>$1</h3>')
          .replace(/^## (.*)$/gm,'<h2>$1</h2>')
          .replace(/^# (.*)$/gm,'<h1>$1</h1>')
          .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
          .replace(/\*(.+?)\*/g,'<em>$1</em>')
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>')
          .replace(/^\s*-\s+(.*)$/gm,'<li>$1</li>')
          .replace(/(<li>.*<\/li>)/g,'<ul>$1</ul>')
          .replace(/^\s*(?!<h|<ul|<pre|<li)(.+)$/gm,'<p>$1</p>');
        return html;
      }
      
      // Update word count
      function updateWordCount() {
        const text = editor.value.trim();
        const count = text ? text.split(/\s+/).length : 0;
        wordCount.textContent = count + ' words';
      }
      
      // Update preview
      function updatePreview() {
        preview.innerHTML = parseMarkdown(editor.value);
      }
      
      // Format text helper
      function formatText(type) {
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        const selection = editor.value.substring(start, end);
        let replacement = '';
        let cursorOffset = 0;
        
        switch(type) {
          case 'bold':
            replacement = `**${selection || 'bold text'}**`;
            cursorOffset = selection ? 0 : 2;
            break;
          case 'italic':
            replacement = `*${selection || 'italic text'}*`;
            cursorOffset = selection ? 0 : 1;
            break;
          case 'heading':
            replacement = `## ${selection || 'Heading'}`;
            cursorOffset = selection ? 0 : 10;
            break;
          case 'link':
            replacement = `[${selection || 'link text'}](url)`;
            cursorOffset = selection ? 3 : 12;
            break;
          case 'list':
            replacement = `- ${selection || 'List item'}`;
            cursorOffset = selection ? 0 : 11;
            break;
          case 'code':
            replacement = `\`\`\`\n${selection || 'code'}\n\`\`\``;
            cursorOffset = selection ? 0 : 4;
            break;
        }
        
        editor.focus();
        const newValue = editor.value.substring(0, start) + replacement + editor.value.substring(end);
        editor.value = newValue;
        
        // Set cursor position
        if (!selection) {
          editor.selectionStart = start + replacement.length - cursorOffset;
          editor.selectionEnd = editor.selectionStart;
        } else {
          editor.selectionStart = start;
          editor.selectionEnd = start + replacement.length;
        }
        
        updateWordCount();
        updatePreview();
        saveData();
      }
      
      // Update layout
      function updateLayout() {
        // Update button states
        editorBtn.classList.toggle('active', visiblePanes.editor);
        previewBtn.classList.toggle('active', visiblePanes.preview);
        corkboardBtn.classList.toggle('active', visiblePanes.corkboard);
        
        // Show/hide panes
        editorPane.style.display = visiblePanes.editor ? 'block' : 'none';
        previewPane.style.display = visiblePanes.preview ? 'block' : 'none';
        corkPane.style.display = visiblePanes.corkboard ? 'block' : 'none';
        
        // Update preview if visible
        if (visiblePanes.preview) {
          updatePreview();
        }
        
        // Count visible panes
        const visibleCount = Object.values(visiblePanes).filter(v => v).length;
        
        if (visibleCount > 1) {
          // Equal width for visible panes
          const width = (100 / visibleCount) + '%';
          if (visiblePanes.editor) editorPane.style.width = width;
          if (visiblePanes.preview) previewPane.style.width = width;
          if (visiblePanes.corkboard) corkPane.style.width = width;
        } else {
          // Full width for single pane
          if (visiblePanes.editor) editorPane.style.width = '100%';
          if (visiblePanes.preview) previewPane.style.width = '100%';
          if (visiblePanes.corkboard) corkPane.style.width = '100%';
        }
        
        saveData();
      }
      
      // Toggle pane visibility
      function togglePane(pane) {
        visiblePanes[pane] = !visiblePanes[pane];
        
        // Ensure at least one pane is visible
        if (!visiblePanes.editor && !visiblePanes.preview && !visiblePanes.corkboard) {
          visiblePanes.editor = true;
        }
        
        updateLayout();
      }
      
      // Save all data
      function saveData() {
        localStorage.setItem('editorText', editor.value);
        localStorage.setItem('visiblePanes', JSON.stringify(visiblePanes));
        
        // Save cytoscape data
        const elements = cy.json().elements;
        if (elements) {
          localStorage.setItem('cytoscapeElements', JSON.stringify(elements));
        }
        
        // Save viewport state
        const viewport = {
          zoom: cy.zoom(),
          pan: cy.pan()
        };
        localStorage.setItem('cytoscapeViewport', JSON.stringify(viewport));
      }
      
      // Load all data
      function loadData() {
        // Load text
        const text = localStorage.getItem('editorText');
        if (text) editor.value = text;
        
        // Load layout
        const panes = localStorage.getItem('visiblePanes');
        if (panes) {
          visiblePanes = JSON.parse(panes);
        }
        
        // Load cytoscape elements
        const elements = localStorage.getItem('cytoscapeElements');
        if (elements) {
          try {
            cy.json({ elements: JSON.parse(elements) });
          } catch (e) {
            console.error('Error loading cytoscape data', e);
          }
        }
        
        // Load viewport
        const viewport = localStorage.getItem('cytoscapeViewport');
        if (viewport) {
          try {
            const { zoom, pan } = JSON.parse(viewport);
            cy.zoom(zoom);
            cy.pan(pan);
          } catch (e) {
            console.error('Error loading viewport', e);
          }
        }
        
        updateLayout();
        updateWordCount();
      }
      
      // Toggle search
      function toggleSearch() {
        searchMode = !searchMode;
        searchContainer.style.display = searchMode ? 'block' : 'none';
        
        if (searchMode) {
          searchInput.focus();
        }
      }
      
      // Search in text and notes
      function search(query) {
        if (!query) return;
        
        // Search in editor
        const text = editor.value.toLowerCase();
        const index = text.indexOf(query.toLowerCase());
        
        if (index >= 0) {
          // Show editor and highlight match
          if (!visiblePanes.editor) {
            visiblePanes.editor = true;
            updateLayout();
          }
          
          editor.focus();
          editor.selectionStart = index;
          editor.selectionEnd = index + query.length;
          return;
        }
        
        // Search in notes
        const nodes = cy.nodes().filter(node => {
          const title = node.data('title') || '';
          const content = node.data('content') || '';
          return title.toLowerCase().includes(query.toLowerCase()) || 
                 content.toLowerCase().includes(query.toLowerCase());
        });
        
        if (nodes.length > 0) {
          // Show corkboard and focus first match
          if (!visiblePanes.corkboard) {
            visiblePanes.corkboard = true;
            updateLayout();
          }
          
          // Select and scroll to the node
          nodes[0].select();
          cy.animate({
            center: { eles: nodes[0] },
            duration: 500
          });
        }
      }
      
      // Helper function to darken a color
      function darkenColor(color, percent) {
        let r = parseInt(color.substr(1, 2), 16);
        let g = parseInt(color.substr(3, 2), 16);
        let b = parseInt(color.substr(5, 2), 16);
        
        r = Math.floor(r * (100 - percent) / 100);
        g = Math.floor(g * (100 - percent) / 100);
        b = Math.floor(b * (100 - percent) / 100);
        
        return `rgb(${r}, ${g}, ${b})`;
      }
      
      // Helper function to lighten a color
      function lightenColor(color, percent) {
        let r = parseInt(color.substr(1, 2), 16);
        let g = parseInt(color.substr(3, 2), 16);
        let b = parseInt(color.substr(5, 2), 16);
        
        r = Math.min(255, Math.floor(r * (100 + percent) / 100));
        g = Math.min(255, Math.floor(g * (100 + percent) / 100));
        b = Math.min(255, Math.floor(b * (100 + percent) / 100));
        
        return `rgb(${r}, ${g}, ${b})`;
      }
      
      // Capture selection from editor
      function captureSelection() {
        const selected = editor.value.substring(editor.selectionStart, editor.selectionEnd);
        
        if (selected) {
          // Make corkboard visible
          if (!visiblePanes.corkboard) {
            visiblePanes.corkboard = true;
            updateLayout();
          }
          
          // Create note with selected text
          createNote(selected);
        } else {
          // Create empty note
          if (!visiblePanes.corkboard) {
            visiblePanes.corkboard = true;
            updateLayout();
          }
          createNote();
        }
      }
      
      // Event listeners
      editorBtn.addEventListener('click', () => togglePane('editor'));
      previewBtn.addEventListener('click', () => togglePane('preview'));
      corkboardBtn.addEventListener('click', () => togglePane('corkboard'));
      
      themeBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark');
        localStorage.setItem('darkMode', document.body.classList.contains('dark'));
      });
      
      searchBtn.addEventListener('click', toggleSearch);
      
      formatBtns.forEach(btn => {
        btn.addEventListener('click', () => formatText(btn.dataset.format));
      });
      
      editor.addEventListener('input', () => {
        updateWordCount();
        updatePreview();
        saveData();
      });
      
      searchInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          search(searchInput.value);
        } else if (e.key === 'Escape') {
          toggleSearch();
        }
      });
      
      // Corkboard controls
      addNoteBtn.addEventListener('click', createNote);
      
      fitBtn.addEventListener('click', () => {
        cy.fit();
      });
      
      layoutBtn.addEventListener('click', () => {
        cy.layout({
          name: 'cose',
          animate: true,
          nodeDimensionsIncludeLabels: true,
          refresh: 20,
          fit: true,
          padding: 30
        }).run();
      });
      
      optionsBtn.addEventListener('click', () => {
        const menu = document.createElement('div');
        menu.className = 'context-menu';
        const rect = optionsBtn.getBoundingClientRect();
        menu.style.left = (rect.left - 100) + 'px';
        menu.style.top = (rect.top - 120) + 'px';
        
        const items = [
          { label: 'Center View', action: () => {
            cy.center();
            cy.zoom(1);
            menu.remove();
          }},
          { label: 'Reset Zoom', action: () => {
            cy.zoom(1);
            menu.remove();
          }},
          { label: 'Delete All Notes', action: () => {
            if (confirm('Are you sure you want to delete all notes?')) {
              cy.elements().remove();
              saveData();
            }
            menu.remove();
          }}
        ];
        
        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'menu-item';
          div.textContent = item.label;
          div.addEventListener('click', item.action);
          menu.appendChild(div);
        });
        
        document.body.appendChild(menu);
        
        const closeMenu = (e) => {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('mousedown', closeMenu);
          }
        };
        
        setTimeout(() => {
          document.addEventListener('mousedown', closeMenu);
        }, 10);
      });
      
      // Note editor
      saveNoteBtn.addEventListener('click', () => {
        if (editingNode) {
          editingNode.data('title', noteTitle.value);
          editingNode.data('content', noteContent.value);
          editingNode.data('label', noteTitle.value + '\n' + noteContent.value);
          noteEditor.style.display = 'none';
          
          // Update node content display
          const div = document.getElementById(editingNode.id() + '-content');
          if (div) {
            const title = div.querySelector('.node-title');
            const content = div.querySelector('.node-text');
            title.textContent = noteTitle.value;
            content.textContent = noteContent.value;
          }
          
          editingNode = null;
          saveData();
        }
      });
      
      cancelNoteBtn.addEventListener('click', () => {
        noteEditor.style.display = 'none';
        editingNode = null;
      });
      
      // Capture button
      captureBtn.addEventListener('click', captureSelection);
      
      // Keyboard shortcuts
      document.addEventListener('keydown', e => {
        if (e.ctrlKey || e.metaKey) {
          if (e.key === '1') {
            togglePane('editor');
            e.preventDefault();
          } else if (e.key === '2') {
            togglePane('preview');
            e.preventDefault();
          } else if (e.key === '3') {
            togglePane('corkboard');
            e.preventDefault();
          } else if (e.key === 'k' || e.key === 'K') {
            toggleSearch();
            e.preventDefault();
          } else if (e.key === '/' || e.key === '?') {
            captureSelection();
            e.preventDefault();
          }
        }
      });
      
      // DOM elements and event listeners - add these where appropriate
      const closeSidebarBtn = document.getElementById('close-sidebar');
      closeSidebarBtn.addEventListener('click', hideNodeSidebar);
      
      // Initialize application
      function init() {
        initCytoscape();
        loadData();
        updateWordCount();
        
        // Apply saved theme
        if (localStorage.getItem('darkMode') === 'true') {
          document.body.classList.add('dark');
        }
      }
      
      init();
    })();
  </script>
</body>
</html>
